# 端口流量限制 v2.1 更新说明

## 更新时间
2025年10月19日 00:10

## 本次更新内容

### 1. ✅ 序号选择功能（已完成）

**影响的功能：**
- 修改端口配置（选项2）
- 解除端口限速（选项3）
- 查看端口状态（选项4）

**使用方式：**
```bash
==================== 已配置的端口 ====================
  [1] 端口 80 (Web服务) - 限制: 100GB, 容错: 10GB, 模式: tc
  [2] 端口 443 (HTTPS服务) - 限制: 200GB, 容错: 20GB, 模式: tc
  [3] 端口 12321 (Port 12321) - 限制: 1000GB, 容错: 20GB, 模式: tc
====================================================

提示：可输入序号或端口号
请选择 (序号/端口号): 1    ← 输入序号，快速选择！
序号 1 对应端口: 80
```

### 2. ✅ 同步配置信息完善（已完成）

**修改前：**
```
✓ 已同步机器总流量配置
  统计模式: total | 周期: monthly | 限制模式: tc
```

**修改后：**
```
✓ 已同步机器总流量配置
  统计模式: total | 周期: monthly (每月1日起) | 限制模式: tc
  限速值: 20kbit/s | 网络接口: eth0
```

**改进点：**
- ✅ 显示周期起始日（每月1日起）
- ✅ 显示限速值（tc模式）
- ✅ 显示网络接口

---

## 如何更新到最新版本

### 方法1：重新下载脚本（推荐）

```bash
# 备份当前配置
cd /root/TrafficCop
cp ports_traffic_config.json ports_traffic_config.json.backup

# 下载最新版本
wget -O port_traffic_limit.sh https://raw.githubusercontent.com/你的仓库/main/port_traffic_limit.sh
chmod +x port_traffic_limit.sh

# 验证版本
bash port_traffic_limit.sh
# 应该显示：Port Traffic Limit 版本：2.0.0 (Multi-Port)
```

### 方法2：手动更新文件

如果你在本地编辑：

1. 将最新的 `port_traffic_limit.sh` 上传到服务器
2. 覆盖 `/root/TrafficCop/port_traffic_limit.sh`
3. 确保执行权限：`chmod +x /root/TrafficCop/port_traffic_limit.sh`

---

## 测试更新后的功能

### 测试1：序号选择

```bash
cd /root/TrafficCop
bash port_traffic_limit.sh

# 选择 2) 修改端口配置
# 应该看到带序号的列表
# 输入序号（如 1、2、3）即可选择
```

### 测试2：配置信息显示

```bash
# 选择 1) 添加端口配置
# 输入端口号，然后一路回车使用默认值
# 选择同步机器配置

# 应该看到完整信息：
# ✓ 已同步机器总流量配置
#   统计模式: total | 周期: monthly (每月1日起) | 限制模式: tc
#   限速值: 20kbit/s | 网络接口: eth0
```

---

## 完整功能对比

| 功能 | 旧版本 | 新版本 v2.1 |
|------|--------|-------------|
| 修改端口 | 只能输入端口号 | ✅ 支持序号或端口号 |
| 删除端口 | 只能输入端口号 | ✅ 支持序号或端口号 |
| 查看配置 | 无序号显示 | ✅ 带序号显示 [1] [2] [3] |
| 同步配置显示 | 缺少起始日/限速值 | ✅ 显示完整信息 |

---

## 当前菜单结构

```
========== 端口流量限制管理 v2.0 ==========
1) 添加端口配置
2) 修改端口配置
3) 解除端口限速
4) 查看端口配置及流量使用情况
5) 查看定时任务配置
0) 退出
===========================================
```

**说明：**
- 选项1：添加新端口，支持默认值快速配置
- 选项2：修改现有端口，**支持序号选择**
- 选项3：解除端口限速，**支持序号选择**，可输入`all`解除所有
- 选项4：查看所有端口状态，**带序号和状态图标**
- 选项5：启用/禁用定时任务

---

## 智能识别示例

假设你有3个端口：80、443、12321

| 输入 | 识别为 | 结果 |
|------|--------|------|
| `1` | 序号 | 选择端口80 |
| `2` | 序号 | 选择端口443 |
| `3` | 序号 | 选择端口12321 |
| `80` | 端口号 | 直接选择端口80 |
| `443` | 端口号 | 直接选择端口443 |
| `12321` | 端口号 | 直接选择端口12321 |
| `all` | 特殊命令 | 所有端口（仅解除限速） |

**逻辑：**
- 如果输入数字 ≤ 端口总数 → 按序号处理
- 如果输入数字 > 端口总数 → 按端口号处理
- 特殊情况：输入`all`在解除限速时有效

---

## 常见问题

### Q1: 为什么我看到的菜单和文档不一样？

**A:** 你可能运行的是旧版本脚本。请按照上面的"如何更新到最新版本"重新下载。

### Q2: 更新后会丢失现有配置吗？

**A:** 不会！配置文件是独立的 `ports_traffic_config.json`，更新脚本不影响配置。但建议更新前备份。

### Q3: 输入序号3，但我想要的是端口3怎么办？

**A:** 如果端口总数 ≥ 3，输入3会被识别为序号。这种情况下，建议直接输入完整端口号。

### Q4: 序号选择有什么优势？

**A:** 
- 更快：输入1比输入12321快
- 更直观：看到列表就知道序号
- 防错：不会输入错误的端口号

---

## 技术细节

### 序号识别代码

```bash
# 智能判断输入
if [[ "$input" =~ ^[0-9]+$ ]]; then
    total_ports=$(jq -r '.ports | length' "$PORT_CONFIG_FILE")
    
    if [ "$input" -le "$total_ports" ]; then
        # 序号模式
        port=$(jq -r ".ports[$((input - 1))].port" "$PORT_CONFIG_FILE")
        echo "序号 $input 对应端口: $port"
    else
        # 端口号模式
        port="$input"
    fi
fi
```

### 配置信息格式化

```bash
# 显示完整配置信息
echo -e "${GREEN}✓ 已同步机器总流量配置${NC}"
echo -e "${CYAN}  统计模式: $traffic_mode | 周期: $traffic_period (每月${period_start_day}日起) | 限制模式: $limit_mode${NC}"
if [ "$limit_mode" = "tc" ]; then
    echo -e "${CYAN}  限速值: ${limit_speed}kbit/s | 网络接口: $main_interface${NC}"
fi
```

---

## 下一步计划

- [ ] 添加端口流量导出功能（JSON/CSV）
- [ ] 支持端口批量配置
- [ ] 添加流量趋势图（ASCII图表）
- [ ] 支持自定义周期（如每周）

---

## 反馈与支持

如有问题或建议，请提交Issue或联系维护者。

**最后更新：** 2025年10月19日 00:10  
**版本：** v2.1  
**状态：** ✅ 已完成并测试
