# 端口流量每日推送功能说明

## 更新时间
**2025-10-19 02:00**

---

## 一、功能概述

**目标**：让每日流量报告不仅包含总流量，还包含每个配置端口的流量使用情况。

### 当前状态

#### ✅ Telegram 通知 (tg_notifier.sh)
- **状态**：已实现端口流量显示功能
- **实现方式**：调用 `view_port_traffic.sh --json` 获取端口数据
- **显示格式**：
  ```
  📊 [机器名]每日流量报告
  
  🖥️ 机器总流量：
  当前使用：980GB
  流量限制：1000GB
  
  🔌 端口流量详情：
  ✅ 端口 12123 (Port 12123)：85.5GB / 100GB (85.5%)
  🟡 端口 12321 (Port 12321)：78.2GB / 100GB (78.2%)
  ✅ 端口 232 (Port 232)：45.3GB / 100GB (45.3%)
  ```

#### ⚠️ PushPlus 通知 (pushplus_notifier.sh)
- **状态**：尝试调用 `get_port_traffic_details()` 但函数不存在
- **需要**：实现该函数或统一使用 JSON 方式

#### ⚠️ Server酱 通知 (serverchan_notifier.sh)
- **状态**：未实现端口流量显示
- **需要**：添加端口流量功能

---

## 二、实现方案

### 方案选择：统一使用 JSON 数据

所有通知脚本统一使用相同的逻辑：
1. 检查端口配置文件是否存在
2. 调用 `view_port_traffic.sh --json` 获取端口数据
3. 解析 JSON 并格式化为各自的消息格式

---

## 三、数据流程

```
端口配置文件
/root/TrafficCop/ports_traffic_config.json
            ↓
检查文件是否存在
            ↓
调用 view_port_traffic.sh --json
            ↓
返回 JSON 数据：
{
  "ports": [
    {
      "port": 12123,
      "description": "Port 12123",
      "usage": 85.50,
      "limit": 100
    },
    ...
  ]
}
            ↓
解析并添加到消息中
            ↓
发送到 Telegram/PushPlus/Server酱
```

---

## 四、Telegram 实现详解

### 1. 检测端口配置

```bash
local ports_config_file="$WORK_DIR/ports_traffic_config.json"
local view_script="$WORK_DIR/view_port_traffic.sh"

if [ -f "$ports_config_file" ]; then
    local port_count=$(jq -r '.ports | length' "$ports_config_file" 2>/dev/null || echo "0")
    
    if [ "$port_count" -gt 0 ]; then
        # 有端口配置，继续处理
    fi
fi
```

### 2. 获取 JSON 数据

```bash
# 优先使用 view_port_traffic.sh 脚本
if [ -f "$view_script" ]; then
    local port_data=$(bash "$view_script" --json 2>/dev/null)
fi
```

### 3. 解析并格式化

```bash
if [ -n "$port_data" ] && echo "$port_data" | jq -e '.ports' >/dev/null 2>&1; then
    local actual_port_count=$(echo "$port_data" | jq -r '.ports | length' 2>/dev/null)
    
    message="${message}%0A%0A🔌 端口流量详情："
    
    local i=0
    while [ $i -lt $actual_port_count ]; do
        local port=$(echo "$port_data" | jq -r ".ports[$i].port")
        local port_desc=$(echo "$port_data" | jq -r ".ports[$i].description")
        local port_usage=$(echo "$port_data" | jq -r ".ports[$i].usage")
        local port_limit=$(echo "$port_data" | jq -r ".ports[$i].limit")
        
        # 计算百分比
        local port_percentage=$(echo "scale=1; ($port_usage / $port_limit) * 100" | bc)
        
        # 选择状态图标
        local status_icon="✅"  # 0-74%
        if (( $(echo "$port_percentage >= 90" | bc -l) )); then
            status_icon="🔴"  # >=90%
        elif (( $(echo "$port_percentage >= 75" | bc -l) )); then
            status_icon="🟡"  # 75-89%
        fi
        
        message="${message}%0A${status_icon} 端口 ${port} (${port_desc})：${port_usage}GB / ${port_limit}GB (${port_percentage}%%)"
        
        i=$((i + 1))
    done
fi
```

### 4. URL 编码说明

Telegram 使用 URL 参数传递消息，需要注意：
- 换行符：`%0A`
- 百分号：`%%`（第一个%用于转义）
- 空格：不需要编码（会自动处理）

---

## 五、PushPlus 实现

### 消息格式：HTML

PushPlus 支持 HTML 格式，更加灵活：

```bash
local title="[${MACHINE_NAME}]每日流量报告"
local content="📊 每日流量报告<br>
🖥️ <b>机器总流量</b><br>
当前使用：$current_usage<br>
流量限制：$limit"

# 检查端口配置
local ports_config_file="$WORK_DIR/ports_traffic_config.json"
local view_script="$WORK_DIR/view_port_traffic.sh"

if [ -f "$ports_config_file" ] && [ -f "$view_script" ]; then
    local port_count=$(jq -r '.ports | length' "$ports_config_file" 2>/dev/null || echo "0")
    
    if [ "$port_count" -gt 0 ]; then
        local port_data=$(bash "$view_script" --json 2>/dev/null)
        
        if [ -n "$port_data" ]; then
            content="${content}<br><br>🔌 <b>端口流量详情</b><br>"
            
            local i=0
            local actual_count=$(echo "$port_data" | jq -r '.ports | length' 2>/dev/null)
            
            while [ $i -lt $actual_count ]; do
                local port=$(echo "$port_data" | jq -r ".ports[$i].port")
                local port_desc=$(echo "$port_data" | jq -r ".ports[$i].description")
                local port_usage=$(echo "$port_data" | jq -r ".ports[$i].usage")
                local port_limit=$(echo "$port_data" | jq -r ".ports[$i].limit")
                
                local port_percentage=$(echo "scale=1; ($port_usage / $port_limit) * 100" | bc 2>/dev/null || echo "0")
                
                local status_icon="✅"
                if (( $(echo "$port_percentage >= 90" | bc -l 2>/dev/null || echo "0") )); then
                    status_icon="🔴"
                elif (( $(echo "$port_percentage >= 75" | bc -l 2>/dev/null || echo "0") )); then
                    status_icon="🟡"
                fi
                
                content="${content}${status_icon} 端口 ${port} (${port_desc})：${port_usage}GB / ${port_limit}GB (${port_percentage}%)<br>"
                
                i=$((i + 1))
            done
        fi
    fi
fi

# 发送消息
response=$(curl -s -X POST "http://www.pushplus.plus/send" \
    -H "Content-Type: application/json" \
    -d "{
        \"token\": \"$PUSHPLUS_TOKEN\",
        \"title\": \"$title\",
        \"content\": \"$content\"
    }")
```

---

## 六、Server酱 实现

### 消息格式：Markdown

Server酱 支持 Markdown 格式：

```bash
local title="[${MACHINE_NAME}]每日流量报告"
local desp="## 📊 每日流量报告

### 🖥️ 机器总流量
- **当前使用**：$current_usage
- **流量限制**：$limit"

# 检查端口配置
local ports_config_file="$WORK_DIR/ports_traffic_config.json"
local view_script="$WORK_DIR/view_port_traffic.sh"

if [ -f "$ports_config_file" ] && [ -f "$view_script" ]; then
    local port_count=$(jq -r '.ports | length' "$ports_config_file" 2>/dev/null || echo "0")
    
    if [ "$port_count" -gt 0 ]; then
        local port_data=$(bash "$view_script" --json 2>/dev/null)
        
        if [ -n "$port_data" ]; then
            desp="${desp}

### 🔌 端口流量详情

| 端口 | 描述 | 使用/限制 | 百分比 | 状态 |
|------|------|-----------|--------|------|"
            
            local i=0
            local actual_count=$(echo "$port_data" | jq -r '.ports | length' 2>/dev/null)
            
            while [ $i -lt $actual_count ]; do
                local port=$(echo "$port_data" | jq -r ".ports[$i].port")
                local port_desc=$(echo "$port_data" | jq -r ".ports[$i].description")
                local port_usage=$(echo "$port_data" | jq -r ".ports[$i].usage")
                local port_limit=$(echo "$port_data" | jq -r ".ports[$i].limit")
                
                local port_percentage=$(echo "scale=1; ($port_usage / $port_limit) * 100" | bc 2>/dev/null || echo "0")
                
                local status="正常"
                if (( $(echo "$port_percentage >= 90" | bc -l 2>/dev/null || echo "0") )); then
                    status="⚠️ 告警"
                elif (( $(echo "$port_percentage >= 75" | bc -l 2>/dev/null || echo "0") )); then
                    status="⚠ 警告"
                fi
                
                desp="${desp}
| $port | $port_desc | ${port_usage}GB / ${port_limit}GB | ${port_percentage}% | $status |"
                
                i=$((i + 1))
            done
        fi
    fi
fi

# 发送消息
local url="https://sctapi.ftqq.com/${SENDKEY}.send"
response=$(curl -s -X POST "$url" \
    -d "title=$title" \
    -d "desp=$desp")
```

---

## 七、状态图标含义

| 使用率 | Telegram | 状态说明 |
|--------|----------|---------|
| 0-74% | ✅ | 正常 |
| 75-89% | 🟡 | 警告 |
| ≥90% | 🔴 | 告警 |

**计算公式：**
```bash
使用率 = (当前使用 / 流量限制) × 100%
```

---

## 八、错误处理

### 1. 配置文件不存在

```bash
if [ ! -f "$ports_config_file" ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') : 端口配置文件不存在"| tee -a "$CRON_LOG"
    # 只发送总流量信息，不包含端口详情
fi
```

### 2. view_port_traffic.sh 不存在

```bash
if [ ! -f "$view_script" ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') : view_port_traffic.sh 脚本不存在"| tee -a "$CRON_LOG"
    # 尝试直接读取配置文件（降级方案）
fi
```

### 3. JSON 解析失败

```bash
if ! echo "$port_data" | jq -e '.ports' >/dev/null 2>&1; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') : JSON 数据无效"| tee -a "$CRON_LOG"
    # 不添加端口信息，只发送总流量
fi
```

### 4. bc 计算错误

```bash
# 所有 bc 调用都添加错误处理
port_percentage=$(echo "scale=1; ($port_usage / $port_limit) * 100" | bc 2>/dev/null || echo "0")

# 所有比较都添加错误处理
if (( $(echo "$port_percentage >= 90" | bc -l 2>/dev/null || echo "0") )); then
    status_icon="🔴"
fi
```

---

## 九、测试方法

### 1. 测试 JSON 输出

```bash
# 检查端口配置文件
cat /root/TrafficCop/ports_traffic_config.json

# 测试 JSON 输出
bash /root/TrafficCop/view_port_traffic.sh --json

# 预期输出：
# {"ports":[
#   {"port":12123,"description":"Port 12123","usage":85.50,"limit":100},
#   {"port":12321,"description":"Port 12321","usage":78.20,"limit":100}
# ]}
```

### 2. 测试每日报告

```bash
# 手动触发 Telegram 每日报告
bash /root/TrafficCop/tg_notifier.sh
# 选择：3) 手动发送每日报告

# 或者直接调用函数（需要先 source 配置）
source /root/TrafficCop/tg_notifier_config.txt
bash -c 'source /root/TrafficCop/tg_notifier.sh && daily_report'
```

### 3. 检查日志

```bash
# 查看 Telegram 日志
tail -50 /root/TrafficCop/tg_notifier_cron.log | grep "端口"

# 查看 PushPlus 日志
tail -50 /root/TrafficCop/pushplus_notifier_cron.log | grep "端口"

# 查看 Server酱 日志
tail -50 /root/TrafficCop/serverchan_cron.log | grep "端口"
```

---

## 十、推送效果示例

### Telegram 消息效果

```
📊 [BWH THE PLAN V1]每日流量报告

🖥️ 机器总流量：
当前使用：980.5GB
流量限制：1000GB

🔌 端口流量详情：
✅ 端口 12123 (Port 12123)：85.5GB / 100GB (85.5%)
🟡 端口 12321 (Port 12321)：78.2GB / 100GB (78.2%)
🔴 端口 232 (Port 232)：95.3GB / 100GB (95.3%)
```

### PushPlus 消息效果

```
[BWH THE PLAN V1]每日流量报告

📊 每日流量报告
🖥️ 机器总流量
当前使用：980.5GB
流量限制：1000GB

🔌 端口流量详情
✅ 端口 12123 (Port 12123)：85.5GB / 100GB (85.5%)
🟡 端口 12321 (Port 12321)：78.2GB / 100GB (78.2%)
🔴 端口 232 (Port 232)：95.3GB / 100GB (95.3%)
```

### Server酱 消息效果

```
[BWH THE PLAN V1]每日流量报告

## 📊 每日流量报告

### 🖥️ 机器总流量
- 当前使用：980.5GB
- 流量限制：1000GB

### 🔌 端口流量详情

| 端口 | 描述 | 使用/限制 | 百分比 | 状态 |
|------|------|-----------|--------|------|
| 12123 | Port 12123 | 85.5GB / 100GB | 85.5% | 正常 |
| 12321 | Port 12321 | 78.2GB / 100GB | 78.2% | ⚠ 警告 |
| 232 | Port 232 | 95.3GB / 100GB | 95.3% | ⚠️ 告警 |
```

---

## 十一、优化建议

### 1. 性能优化

- **缓存 JSON 数据**：避免多次调用 `view_port_traffic.sh`
- **并行处理**：如果端口很多，可以考虑并行获取流量

### 2. 功能增强

- **趋势显示**：对比昨天的使用量，显示增长趋势
- **预警提醒**：端口使用率超过阈值时单独推送
- **图表统计**：生成流量使用图表（需要额外工具）

### 3. 用户体验

- **可配置开关**：允许用户选择是否在每日报告中包含端口详情
- **自定义格式**：允许用户自定义消息模板
- **多语言支持**：支持中英文等多语言

---

## 十二、相关文件

**修改的文件：**
1. `tg_notifier.sh` - 已实现端口流量显示
2. `pushplus_notifier.sh` - 需要完善端口流量显示
3. `serverchan_notifier.sh` - 需要添加端口流量显示

**依赖的文件：**
1. `view_port_traffic.sh` - 提供 JSON 数据接口
2. `ports_traffic_config.json` - 端口配置文件

---

## 十三、下一步计划

1. ✅ Telegram - 已实现
2. ⬜ PushPlus - 待完善
3. ⬜ Server酱 - 待实现
4. ⬜ 测试所有推送渠道
5. ⬜ 编写使用文档
6. ⬜ 推送到 GitHub

---

**文档更新时间：** 2025-10-19 02:00  
**功能状态：** Telegram 已实现，其他待完善  
**优先级：** 高
