# 序号选择功能说明

## 功能概述

现在所有涉及端口选择的操作都支持**序号选择**，让操作更加便捷！

---

## 改进的功能

### 1. 查看端口配置及流量使用情况

**显示效果：**
```
==================== 端口配置与流量状态 ====================

[1] 端口 80 - Web服务
    流量限制: 100GB (容错: 10GB)
    限制模式: tc (20kbit/s)
    网络接口: eth0
    当前使用: 35.5GB / 100GB (35.5%)
    状态: ✅ 正常

[2] 端口 443 - HTTPS服务
    流量限制: 200GB (容错: 20GB)
    限制模式: tc (50kbit/s)
    网络接口: eth0
    当前使用: 150.2GB / 200GB (75.1%)
    状态: 🟡 需要关注

[3] 端口 8080 - API服务
    流量限制: 50GB (容错: 5GB)
    限制模式: shutdown
    网络接口: eth0
    当前使用: 48.8GB / 50GB (97.6%)
    状态: ⚠️  接近限制

==========================================================
```

---

### 2. 修改端口配置

**操作流程：**
```
==================== 已配置的端口 ====================
  [1] 端口 80 (Web服务) - 限制: 100GB, 容错: 10GB, 模式: tc
  [2] 端口 443 (HTTPS服务) - 限制: 200GB, 容错: 20GB, 模式: tc
  [3] 端口 8080 (API服务) - 限制: 50GB, 容错: 5GB, 模式: shutdown
====================================================

提示：可输入序号或端口号
请选择 (序号/端口号): 2          ← 输入序号
序号 2 对应端口: 443

==================== 修改端口配置 ====================
提示：所有选项可直接回车保持原值

当前配置：
  端口: 443
  描述: HTTPS服务
  限制: 200GB (容错: 20GB)

端口描述 [回车=HTTPS服务]: 
流量限制(GB) [回车=200]: 300      ← 修改限制为300GB
容错范围(GB) [回车=20]: 
...
```

**智能识别：**
- 输入 `1`、`2`、`3` → 识别为序号
- 输入 `80`、`443`、`8080` → 识别为端口号
- 系统会自动判断并提示

---

### 3. 解除端口限速

**操作流程：**
```
==================== 已配置的端口 ====================
  [1] 端口 80 (Web服务) - 限制: 100GB, 容错: 10GB, 模式: tc
  [2] 端口 443 (HTTPS服务) - 限制: 200GB, 容错: 20GB, 模式: tc
  [3] 端口 8080 (API服务) - 限制: 50GB, 容错: 5GB, 模式: shutdown
====================================================

提示：可输入序号、端口号或'all'
请选择 (序号/端口号/all): 1      ← 输入序号
序号 1 对应端口: 80
端口 80 限速已解除
```

**支持的输入方式：**
- `1` → 解除序号1的端口（80）
- `443` → 直接解除端口443
- `all` → 解除所有端口限速

---

### 4. 列表显示优化

**所有端口列表现在都带序号：**
```
==================== 已配置的端口 ====================
  [1] 端口 80 (Web服务) - 限制: 100GB, 容错: 10GB, 模式: tc
  [2] 端口 443 (HTTPS服务) - 限制: 200GB, 容错: 20GB, 模式: tc
  [3] 端口 8080 (API服务) - 限制: 50GB, 容错: 5GB, 模式: shutdown
====================================================
```

**优势：**
- 清晰的序号标识
- 支持快速选择（不用输入完整端口号）
- 绿色高亮显示序号

---

## 智能识别逻辑

系统会根据输入智能判断：

| 输入值 | 端口总数 | 识别为 | 说明 |
|--------|----------|--------|------|
| `1` | 3 | 序号 | ≤ 端口总数，识别为序号 |
| `2` | 3 | 序号 | ≤ 端口总数，识别为序号 |
| `80` | 3 | 端口号 | > 端口总数，识别为端口号 |
| `443` | 3 | 端口号 | > 端口总数，识别为端口号 |
| `all` | 任意 | 特殊命令 | 解除所有端口 |

**示例场景：**
```
假设配置了端口：80, 443, 8080 (共3个)

输入 1  → 序号1 → 端口80
输入 2  → 序号2 → 端口443
输入 3  → 序号3 → 端口8080
输入 80 → 端口号 → 端口80
输入 99 → 端口号 → 端口99 (如果存在)
```

---

## 使用建议

### 快速操作
推荐使用序号，更快捷：
```
修改端口？输入: 1
解除限速？输入: 2
```

### 精确指定
如果记得端口号，也可以直接输入：
```
修改端口？输入: 443
解除限速？输入: 8080
```

### 批量操作
解除所有限速：
```
请选择: all
```

---

## 状态图标说明

在查看端口状态时，会显示不同的状态图标：

| 图标 | 状态 | 使用率 | 说明 |
|------|------|--------|------|
| ✅ | 正常 | < 70% | 流量使用正常 |
| 🟡 | 需要关注 | 70% - 90% | 接近限制，需要关注 |
| ⚠️ | 接近限制 | > 90% | 即将达到限制，可能触发限速 |

---

## 完整操作示例

### 场景：修改端口443的流量限制

```bash
# 1. 进入端口管理菜单
bash trafficcop-manager.sh
选择: 5

# 2. 选择修改端口配置
选择: 2

# 3. 看到端口列表（带序号）
  [1] 端口 80 (Web服务)
  [2] 端口 443 (HTTPS服务)    ← 要修改这个
  [3] 端口 8080 (API服务)

# 4. 输入序号或端口号
请选择: 2                       ← 输入序号2
序号 2 对应端口: 443            ← 系统确认

# 5. 按需修改配置（回车保持原值）
流量限制(GB) [回车=200]: 300    ← 改为300GB
容错范围(GB) [回车=20]:         ← 回车保持20GB

# 6. 完成
✓ 端口 443 配置已更新！
```

---

## 技术实现

### 核心逻辑

```bash
# 智能识别输入
if [[ "$input" =~ ^[0-9]+$ ]]; then
    total_ports=$(jq -r '.ports | length' "$PORT_CONFIG_FILE")
    
    if [ "$input" -le "$total_ports" ]; then
        # 作为序号处理
        port=$(jq -r ".ports[$((input - 1))].port" "$PORT_CONFIG_FILE")
        echo "序号 $input 对应端口: $port"
    else
        # 作为端口号处理
        port="$input"
    fi
fi
```

### 序号生成

```bash
# 在列表显示时添加序号
local index=1
jq -r '.ports[] | ...' | while ...; do
    echo "[${index}] 端口 ${port} ..."
    index=$((index + 1))
done
```

---

## 更新日期

2025年10月19日

## 版本

TrafficCop v2.1
