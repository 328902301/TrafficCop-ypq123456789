# 端口流量显示精度修复说明

## 🐛 问题描述

用户反馈：Telegram 推送的端口流量显示被取整了，应该保留 2 位小数，和日志记录的格式一致。

**问题截图：**
```
端口 55549 (Port 55549)：0GB / 1000GB (0%)
端口 11710 (Port 11710)：0GB / 1000GB (0%)
```

**期望显示：**
```
端口 55549 (Port 55549)：0.54GB / 1000GB (0.05%)
端口 11710 (Port 11710)：0.00GB / 1000GB (0.00%)
```

---

## 🔍 根本原因

### 问题分析

1. **JSON 数据本身是正确的**
   - `view_port_traffic.sh` 输出的 JSON 包含小数
   - 例如：`{"port":55549,"usage":0.542,"limit":1000}`

2. **通知脚本显示时丢失精度**
   - 从 JSON 提取数据后直接拼接字符串
   - Bash 变量在某些情况下会截断小数
   - 没有使用 `printf` 格式化输出

3. **百分比精度也不一致**
   - 原代码使用 `scale=1`（保留1位小数）
   - 应该使用 `scale=2`（保留2位小数）

### 代码问题

**原代码（有问题）：**
```bash
local port_usage=$(echo "$port_data" | jq -r ".ports[$i].usage")
local port_limit=$(echo "$port_data" | jq -r ".ports[$i].limit")

# 直接使用，可能丢失精度
message="${message}...${port_usage}GB / ${port_limit}GB..."
```

**问题：**
- `port_usage` 可能是 `0.542`
- 直接拼接可能变成 `0GB` 或 `1GB`（取整）
- 百分比 `scale=1` 只保留1位小数

---

## ✅ 修复方案

### 修复策略

使用 `printf` 格式化数字输出，确保：
1. 流量显示保留 **2 位小数**
2. 百分比显示保留 **2 位小数**
3. 统一三个通知系统的显示格式

### 修复代码

#### Telegram 通知 (tg_notifier.sh)

**修改前：**
```bash
local port_usage=$(echo "$port_data" | jq -r ".ports[$i].usage")
local port_limit=$(echo "$port_data" | jq -r ".ports[$i].limit")

# 计算使用百分比
local port_percentage=0
if [ -n "$port_limit" ] && [ "$port_limit" != "null" ] && (( $(echo "$port_limit > 0" | bc -l) )); then
    port_percentage=$(echo "scale=1; ($port_usage / $port_limit) * 100" | bc)
fi

message="${message}%0A${status_icon} 端口 ${port} (${port_desc})：${port_usage}GB / ${port_limit}GB (${port_percentage}%%)"
```

**修改后：**
```bash
local port_usage=$(echo "$port_data" | jq -r ".ports[$i].usage")
local port_limit=$(echo "$port_data" | jq -r ".ports[$i].limit")

# 格式化流量显示（保留2位小数）
local port_usage_formatted=$(printf "%.2f" "$port_usage" 2>/dev/null || echo "$port_usage")
local port_limit_formatted=$(printf "%.2f" "$port_limit" 2>/dev/null || echo "$port_limit")

# 计算使用百分比（保留2位小数）
local port_percentage=0
if [ -n "$port_limit" ] && [ "$port_limit" != "null" ] && (( $(echo "$port_limit > 0" | bc -l) )); then
    port_percentage=$(printf "%.2f" $(echo "scale=2; ($port_usage / $port_limit) * 100" | bc))
fi

message="${message}%0A${status_icon} 端口 ${port} (${port_desc})：${port_usage_formatted}GB / ${port_limit_formatted}GB (${port_percentage}%%)"
```

**优化点：**
1. ✅ 使用 `printf "%.2f"` 格式化流量（2位小数）
2. ✅ 百分比从 `scale=1` 改为 `scale=2`
3. ✅ 百分比也用 `printf` 格式化
4. ✅ 添加错误处理（`2>/dev/null || echo "$port_usage"`）

#### PushPlus 通知 (pushplus_notifier.sh)

**同样的修复逻辑：**
```bash
# 格式化流量显示（保留2位小数）
local port_usage_formatted=$(printf "%.2f" "$port_usage" 2>/dev/null || echo "$port_usage")
local port_limit_formatted=$(printf "%.2f" "$port_limit" 2>/dev/null || echo "$port_limit")

# 计算使用百分比（保留2位小数）
port_percentage=$(printf "%.2f" $(echo "scale=2; ($port_usage / $port_limit) * 100" | bc))

content="${content}${status_icon} 端口 ${port} (${port_desc})：${port_usage_formatted}GB / ${port_limit_formatted}GB (${port_percentage}%)<br>"
```

#### Server酱 通知 (serverchan_notifier.sh)

**同样的修复逻辑：**
```bash
# 格式化流量显示（保留2位小数）
local port_usage_formatted=$(printf "%.2f" "$port_usage" 2>/dev/null || echo "$port_usage")
local port_limit_formatted=$(printf "%.2f" "$port_limit" 2>/dev/null || echo "$port_limit")

# 计算使用百分比（保留2位小数）
port_percentage=$(printf "%.2f" $(echo "scale=2; ($port_usage / $port_limit) * 100" | bc))

desp="${desp}%0A| $port | $port_desc | ${port_usage_formatted}GB / ${port_limit_formatted}GB | ${port_percentage}%% | $status |"
```

---

## 📊 修复效果对比

### Telegram 消息

**修改前：**
```
🔌 端口流量详情：
✅ 端口 55549 (Port 55549)：0GB / 1000GB (0%)
✅ 端口 11710 (Port 11710)：0GB / 1000GB (0%)
```

**修改后：**
```
🔌 端口流量详情：
✅ 端口 55549 (Port 55549)：0.54GB / 1000.00GB (0.05%)
✅ 端口 11710 (Port 11710)：0.00GB / 1000.00GB (0.00%)
```

### PushPlus 消息

**修改前：**
```html
🔌 端口流量详情
✅ 端口 55549 (Port 55549)：0GB / 1000GB (0%)<br>
```

**修改后：**
```html
🔌 端口流量详情
✅ 端口 55549 (Port 55549)：0.54GB / 1000.00GB (0.05%)<br>
```

### Server酱 消息（Markdown表格）

**修改前：**
```
| 端口 | 描述 | 使用/限制 | 百分比 | 状态 |
|------|------|-----------|--------|------|
| 55549 | Port 55549 | 0GB / 1000GB | 0% | ✅ 正常 |
```

**修改后：**
```
| 端口 | 描述 | 使用/限制 | 百分比 | 状态 |
|------|------|-----------|--------|------|
| 55549 | Port 55549 | 0.54GB / 1000.00GB | 0.05% | ✅ 正常 |
```

### 日志记录对比

**日志格式（已经是正确的）：**
```
2025-10-19 03:30:01 端口 55549: 入站=0.32GB, 出站=0.22GB, 总计=0.54GB, 当前=0.54GB, 限制=1000GB (0.05%)
```

**现在通知消息和日志格式一致了！** ✅

---

## 🚀 更新步骤

### 在服务器上更新

```bash
# 1. 更新三个通知脚本
cd /root/TrafficCop

wget -O tg_notifier.sh https://raw.githubusercontent.com/ypq123456789/TrafficCop/main/tg_notifier.sh
wget -O pushplus_notifier.sh https://raw.githubusercontent.com/ypq123456789/TrafficCop/main/pushplus_notifier.sh
wget -O serverchan_notifier.sh https://raw.githubusercontent.com/ypq123456789/TrafficCop/main/serverchan_notifier.sh

chmod +x tg_notifier.sh pushplus_notifier.sh serverchan_notifier.sh

# 2. 手动测试每日报告
bash /root/TrafficCop/tg_notifier.sh
# 选择：3) 手动发送每日报告

# 3. 查看推送的消息，验证格式
```

### 预期效果

发送测试报告后，应该看到：

**Telegram：**
```
📊 [BWH THE PLAN V1]每日流量报告

🖥️ 机器总流量：
当前使用：0.54GB
流量限制：1000GB

🔌 端口流量详情：
✅ 端口 55549 (Port 55549)：0.54GB / 1000.00GB (0.05%)
✅ 端口 11710 (Port 11710)：0.00GB / 1000.00GB (0.00%)
```

---

## 🎯 技术细节

### printf 格式化说明

```bash
# 格式化为2位小数
printf "%.2f" 0.542
# 输出: 0.54

printf "%.2f" 0.5
# 输出: 0.50

printf "%.2f" 0
# 输出: 0.00

printf "%.2f" 1000
# 输出: 1000.00
```

### 为什么需要 printf？

**问题示例：**
```bash
# 直接使用变量（可能丢失精度）
value=0.542
echo "$value GB"
# 某些情况下可能输出: 0 GB 或 1 GB

# 使用 printf（保证精度）
value=0.542
echo "$(printf "%.2f" $value) GB"
# 输出: 0.54 GB
```

### bc 精度设置

**修改前：**
```bash
echo "scale=1; ($usage / $limit) * 100" | bc
# 输出: 0.5  （1位小数）
```

**修改后：**
```bash
printf "%.2f" $(echo "scale=2; ($usage / $limit) * 100" | bc)
# 输出: 0.54  （2位小数）
```

---

## ✅ 验证清单

更新后请验证：

- [ ] 端口流量显示保留 2 位小数（例如 0.54GB）
- [ ] 流量限制显示保留 2 位小数（例如 1000.00GB）
- [ ] 使用百分比保留 2 位小数（例如 0.05%）
- [ ] 小流量显示正确（例如 0.00GB 而不是 0GB）
- [ ] 大流量显示正确（例如 42.35GB）
- [ ] Telegram、PushPlus、Server酱三个通知格式统一
- [ ] 通知消息格式和日志格式一致

---

## 🔍 常见问题

### Q1: 为什么 limit 也要格式化？

**原因：** JSON 中的 limit 是整数（例如 1000），但格式化后显示为 `1000.00GB`，与 usage 格式保持一致。

**对比：**
```
不统一：0.54GB / 1000GB
统一：  0.54GB / 1000.00GB  ✅
```

---

### Q2: 如果 printf 失败怎么办？

**处理：** 代码中使用了降级处理：
```bash
printf "%.2f" "$port_usage" 2>/dev/null || echo "$port_usage"
```

如果 `printf` 失败，会使用原始值。

---

### Q3: 百分比为什么也改成 2 位小数？

**原因：** 统一精度，更准确。

**对比：**
```
1位小数：0.5%   （不够精确）
2位小数：0.54%  （更精确）
```

对于小流量，2位小数更能体现实际使用情况。

---

## 🎉 总结

**修复内容：**
1. ✅ Telegram 端口流量显示精度修复（2位小数）
2. ✅ PushPlus 端口流量显示精度修复（2位小数）
3. ✅ Server酱 端口流量显示精度修复（2位小数）
4. ✅ 百分比计算精度统一为2位小数

**修改文件：**
- `tg_notifier.sh`
- `pushplus_notifier.sh`
- `serverchan_notifier.sh`

**影响范围：**
- ✅ 每日流量报告推送
- ✅ 端口流量详情显示
- ⚪ 不影响流量监控和限制功能

**推送状态：** 待推送到 GitHub

---

**文档更新时间：** 2025-10-19 03:30  
**修复版本：** 通知脚本精度优化  
**状态：** ✅ 本地修复完成，待测试并推送
